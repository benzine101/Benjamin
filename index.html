<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 4.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai+Looped:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Noto Sans Thai Looped', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }
        
        #controls h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 16px;
        }
        
        .control-group {
            margin-bottom: 10px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 12px;
            color: #555;
        }
        
        .control-group input, .control-group select {
            width: 150px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
        }
        
        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 14px;
            max-width: 300px;
        }
        
        .building-info {
            margin-bottom: 8px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        #pieChartContainer {
            position: absolute;
            left: 20px;
            bottom: 20px;
            width: 320px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            padding: 16px;
            z-index: 110;
        }
        
        #pieChartDiv {
            width: 280px;
            height: 200px;
        }
        
        #chartContainer {
            position: absolute;
            top: 20px;
            right: 20px;
            left: auto;
            transform: none;
            width: 320px;
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 16px;
            z-index: 100;
        }
        
        #chartDiv {
            width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            box-sizing: border-box;
        }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏° CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö risk summary ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î */
        .risk-summary {
          background: #e3f2fd;
          border-radius: 8px;
          padding: 10px 14px;
          margin-bottom: 10px;
          text-align: center;
        }
        .risk-title {
          font-weight: bold;
          color: #1976d2;
          font-size: 16px;
          margin-bottom: 4px;
        }
        .risk-value {
          color: #d32f2f;
          font-size: 15px;
          font-weight: 500;
        }
        .risk-level-box {
          background: #fff3e0;
          border-left: 5px solid #ffa726;
          border-radius: 6px;
          padding: 8px 12px;
          margin-bottom: 10px;
          font-size: 14px;
        }
        .risk-level-label {
          font-weight: bold;
          color: #ff9800;
        }
        .risk-level-value {
          color: #d32f2f;
          font-weight: bold;
          margin-left: 6px;
        }
        .risk-detail-list {
          width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
          box-sizing: border-box;
          max-height: 340px;
          overflow-y: auto;
          overflow-x: hidden;
          /* scrollbar ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
          scrollbar-width: thin;
          scrollbar-color: #90caf9 #e3f2fd;
          margin-right: -8px;
          margin-top: 18px;
        }
        .risk-detail-list::-webkit-scrollbar {
          width: 8px;
          background: transparent;
        }
        .risk-detail-list::-webkit-scrollbar-thumb {
          background: #90caf9;
          border-radius: 4px;
        }
        .risk-detail-row:nth-child(even) {
          background: #f5fafd;
        }
        .risk-detail-row:nth-child(odd) {
          background: #fff;
        }
        .risk-detail-label {
          color: #333;
        }
        .risk-detail-value {
          color: #1976d2;
          font-weight: 500;
          padding-right: 16px;
        }
        .risk-detail-value.passed {
          color: #388e3c;
          font-weight: bold;
        }
        .risk-detail-value.failed {
          color: #d32f2f;
          font-weight: bold;
        }
        .risk-detail-value.pending {
          color: #ffa000;
          font-weight: bold;
        }
        .risk-detail-value .status-icon {
          margin-right: 4px;
          font-size: 16px;
          vertical-align: middle;
        }
        /* DEBUG: ‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞ force hover effect */
        .risk-detail-row {
          width: 100%;
          box-sizing: border-box;
          margin: 0;
          padding: 6px 0;
          display: flex;
          justify-content: space-between;
          border-bottom: 1px solid #f0f0f0;
          font-size: 14px;
          transition: none;
          align-items: center;
        }
        /* ‡∏•‡∏ö hover effect ‡∏≠‡∏≠‡∏Å */
        /* .risk-detail-row:hover {
          background: #e3f2fd !important;
          transform: scale(1.02) !important;
        } */

        #mainHeader {
          width: 600px;
          max-width: 90vw;
          background: rgba(255,255,255,0.92);
          box-shadow: 0 2px 12px rgba(0,0,0,0.10);
          padding: 18px 0 12px 0;
          text-align: center;
          position: fixed;
          top: 24px;
          left: 50%;
          transform: translateX(-50%);
          border-radius: 16px;
          z-index: 300;
          font-family: 'Noto Sans Thai Looped', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-header-icon {
          font-size: 2.2rem;
          vertical-align: middle;
          margin-right: 12px;
          font-family: 'Noto Sans Thai Looped', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .main-title {
          font-size: 2rem;
          font-weight: bold;
          color: #1976d2;
          vertical-align: middle;
          letter-spacing: 1px;
          font-family: 'Noto Sans Thai Looped', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body>
    <div id="mainHeader">
      <span class="main-header-icon" aria-label="IT">üõ°Ô∏è</span>
      <span class="main-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</span>
    </div>
    <div id="container">
        <div id="controls">
            <h3>üè¢ ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÇ‡∏°‡πÄ‡∏î‡∏•</h3>
            <div class="control-group">
                <label>‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á:</label>
                <select id="viewSelect">
                    <option value="perspective">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</option>
                    <option value="top">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</option>
                    <option value="front">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤</option>
                    <option value="side">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á</option>
                </select>
            </div>
            <div class="control-group">
                <label>‡πÅ‡∏™‡∏á:</label>
                <input type="range" id="lightIntensity" min="0.5" max="2" step="0.1" value="1">
            </div>
            <div class="control-group">
                <label>‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:</label>
                <select id="dataSource">
                    <option value="mock">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á</option>
                    <option value="sheets">Google Sheets</option>
                    <option value="excel">Excel File</option>
                </select>
            </div>
            <div class="control-group" id="fileUploadGroup" style="display: none;">
                <label>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel:</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv">
            </div>
            <div class="control-group">
                <label>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü:</label>
                <select id="chartColumns">
                    <option value="0,1">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 1-2 (Building, Floor)</option>
                    <option value="3,4" selected>‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 4-5 (Item 1, Count 1)</option>
                    <option value="5,6">‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 6-7 (Item 2, Count 2)</option>
                    <option value="custom">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á</option>
                </select>
            </div>
            <div class="control-group">
                <button onclick="testGoogleSheets()" style="padding: 5px 10px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">‡∏ó‡∏î‡∏™‡∏≠‡∏ö Google Sheets</button>
            </div>
            <div class="control-group">
                <button onclick="refreshGoogleSheets()" style="padding: 5px 10px; background: #43a047; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheets</button>
            </div>
            <div class="control-group">
                <button onclick="showPieChartFromColumnB()" style="padding: 5px 10px; background: #FF9800; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">Pie Chart ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô</button>
            </div>
            <div class="control-group">
                <button onclick="showPieChartForRoom()" style="padding: 5px 10px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">Pie Chart ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</button>
            </div>
        </div>
        
        <div id="pieChartContainer" style="display: none; position: absolute; left: 20px; bottom: 20px; width: 320px; background: #fff; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 16px; z-index: 110;">
            <h3 style="margin-top:0; font-size:16px; color:#333;">Pie Chart ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h3>
            <div id="pieChartDiv" style="width: 280px; height: 200px;"></div>
            <button onclick="closePieChart()" style="margin-top: 10px; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">‡∏õ‡∏¥‡∏î</button>
        </div>
        
        <div id="chartContainer" style="display: none; position: absolute; top: 20px; right: 20px; left: auto; transform: none; width: 320px; background: rgba(255,255,255,0.95); border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); padding: 16px; z-index: 100;">
            <h3 id="chartTitle">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á</h3>
            <div id="chartDiv" style="width: 280px; height: 470px;"></div>
            <button onclick="closeChart()" style="margin-top: 10px; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">‡∏õ‡∏¥‡∏î</button>
        </div>
        <div id="pieChartContainer2" style="display: none; position: absolute; bottom: 20px; right: 380px; left: auto; transform: none; width: 320px; background: #fff; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); padding: 16px; z-index: 110;">
            <h3 style="margin-top:0; font-size:16px; color:#333;">Pie Chart ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</h3>
            <div id="pieChartDiv2" style="width: 280px; height: 200px;"></div>
            <button onclick="closePieChart2()" style="margin-top: 10px; padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏´‡∏•‡∏±‡∏Å
        let scene, camera, renderer, buildings = [];
        let autoRotate = true; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ autoRotate
        let raycaster, mouse; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö raycasting
        let selectedRoom = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        let uploadedExcelData = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel ‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
        let sheetData = null; // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet
        
        const buildingColors = [
            0xFFFFFF, // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            0xFFFFFF, // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            0xFFFFFF, // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            0xFFFFFF, // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            0xFFFFFF, // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            0xFFFFFF, // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
            0xFFFFFF  // ‡∏™‡∏µ‡∏Ç‡∏≤‡∏ß
        ];
        
        // ‡∏™‡πÄ‡∏Å‡∏•‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ç‡∏ô‡∏≤‡∏î‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ 25%
        const BUILDING_SCALE = 1.25;

        const roomDataMapping = {
          '‡∏Å‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£': { row: 3, col: 'B' },
          '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï': { row: 4, col: 'B' },
          '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®': { row: 5, col: 'B' },
          '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏±‡∏Å‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç': { row: 6, col: 'B' },
          '‡∏™‡πç‡∏≤‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏≤‡∏ô‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡πç‡∏≤‡∏ö‡∏±‡∏î‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î': { row: 7, col: 'B' },
          '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç': { row: 8, col: 'B' },
          '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå': { row: 9, col: 'B' },
          '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•': { row: 10, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•': { row: 11, col: 'B' },
          '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°': { row: 12, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á': { row: 13, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á': { row: 14, col: 'B' },
          '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢': { row: 15, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô': { row: 16, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û': { row: 17, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏ê‡∏°‡∏†‡∏π‡∏°‡∏¥': { row: 18, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô': { row: 19, col: 'B' },
          '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô': { row: 20, col: 'B' },
          '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£': { row: 21, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢': { row: 22, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': { row: 23, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•': { row: 24, col: 'B' },
          '‡∏Å‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç': { row: 25, col: 'B' },
          '‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£': { row: 26, col: 'B' }
        };

        function init() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            scene.fog = new THREE.Fog(0x87CEEB, 100, 1000);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(50, 40, 50);
            camera.lookAt(0, 0, 0);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.sortObjects = true;
            renderer.setClearColor(0x87CEEB, 1);
            document.getElementById('container').appendChild(renderer.domElement);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Raycaster ‡πÅ‡∏•‡∏∞ Mouse
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏™‡∏á
            createLights();
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏∑‡πâ‡∏ô
            createGround();
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÉ‡∏ô Google Map
            createBuildingsFromMap();
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°
            const clouds = createEnvironment(); // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏°‡∏Ü‡πÑ‡∏ß‡πâ
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listeners
            setupControls();
            
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ Render
            animate(clouds); // ‡∏™‡πà‡∏á‡πÄ‡∏°‡∏Ü‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô animate
        }

        function createLights() {
            // ‡πÅ‡∏™‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            // ‡πÅ‡∏™‡∏á‡∏´‡∏•‡∏±‡∏Å
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.1);
            directionalLight.position.set(50, 60, 25);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 500;
            directionalLight.shadow.camera.left = -50;
            directionalLight.shadow.camera.right = 50;
            directionalLight.shadow.camera.top = 50;
            directionalLight.shadow.camera.bottom = -50;
            scene.add(directionalLight);

            // ‡πÅ‡∏™‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°
            const spotLight = new THREE.SpotLight(0xffffff, 0.5);
            spotLight.position.set(-30, 40, 30);
            spotLight.angle = Math.PI / 4;
            spotLight.penumbra = 0.1;
            spotLight.decay = 2;
            spotLight.distance = 200;
            scene.add(spotLight);
        }

        function createGround() {
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshLambertMaterial({ 
                color: 0x90EE90,
                transparent: true,
                opacity: 0.8
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
        }

        function createBuildingsFromMap() {
            // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ï‡∏≤‡∏° Google Map (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡∏°‡πà)
            const buildingConfigs = [
                // ‡∏Ç‡∏≤ A ‡∏ã‡πâ‡∏≤‡∏¢ (‡∏•‡∏≤‡∏î‡∏•‡∏á)
                { x: -5 * BUILDING_SCALE, z: 15 * BUILDING_SCALE, width: 4 * BUILDING_SCALE, depth: 10 * BUILDING_SCALE, color: buildingColors[0] },
                { x: -7 * BUILDING_SCALE, z: 5 * BUILDING_SCALE, width: 4 * BUILDING_SCALE, depth: 10 * BUILDING_SCALE, color: buildingColors[1] },
                { x: -5 * BUILDING_SCALE, z: -5 * BUILDING_SCALE, width: 4 * BUILDING_SCALE, depth: 10 * BUILDING_SCALE, color: buildingColors[2] },

                // ‡∏Ç‡∏≤ A ‡∏Ç‡∏ß‡∏≤ (‡∏•‡∏≤‡∏î‡∏•‡∏á)
                { x: 5 * BUILDING_SCALE, z: 15 * BUILDING_SCALE, width: 4 * BUILDING_SCALE, depth: 10 * BUILDING_SCALE, color: buildingColors[3] },
                { x: 7 * BUILDING_SCALE, z: 5 * BUILDING_SCALE, width: 4 * BUILDING_SCALE, depth: 10 * BUILDING_SCALE, color: buildingColors[4] },
                { x: 5 * BUILDING_SCALE, z: -5 * BUILDING_SCALE, width: 4 * BUILDING_SCALE, depth: 10 * BUILDING_SCALE, color: buildingColors[5] },

                { x: 0, z: -12 * BUILDING_SCALE, width: 12 * BUILDING_SCALE, depth: 10 * BUILDING_SCALE, color: buildingColors[6] }
            ];

            buildingConfigs.forEach((config, index) => {
                const building = createBuilding(config, index + 1);
                buildings.push(building.group);
                scene.add(building.group);
            });
        }

        function createBuilding(config, buildingNumber) {
            const group = new THREE.Group();
            const floorHeight = 3.2 * BUILDING_SCALE;
            let totalHeight;
            
            if (buildingNumber === 7) {
                totalHeight = 5 * floorHeight;
            } else {
                totalHeight = 7 * floorHeight;
            }

            let buildingMesh;
            if (buildingNumber === 7) {
                const pentagonShape = new THREE.Shape();
                const r = (config.width / 2);
                for (let i = 0; i < 5; i++) {
                    const angle = (i / 5) * Math.PI * 2 - Math.PI / 2;
                    const x = Math.cos(angle) * r;
                    const y = Math.sin(angle) * r;
                    if (i === 0) pentagonShape.moveTo(x, y);
                    else pentagonShape.lineTo(x, y);
                }
                pentagonShape.closePath();
                const extrudeSettings = {
                    steps: 1,
                    depth: totalHeight,
                    bevelEnabled: true,
                    bevelThickness: 0.1 * BUILDING_SCALE,
                    bevelSize: 0.05 * BUILDING_SCALE,
                    bevelSegments: 3
                };
                const geometry = new THREE.ExtrudeGeometry(pentagonShape, extrudeSettings);
                geometry.rotateX(Math.PI / 2);
                geometry.translate(config.x, totalHeight, config.z);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xE8E8E8, // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï
                    roughness: 0.8,
                    metalness: 0.1,
                    transparent: true,
                    opacity: 0.7 // ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î
                });
                buildingMesh = new THREE.Mesh(geometry, material);
                buildingMesh.castShadow = true;
                buildingMesh.receiveShadow = true;
                group.add(buildingMesh);
            } else {
                const buildingGeometry = new THREE.BoxGeometry(config.width, totalHeight, config.depth);
                const buildingMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xE8E8E8, // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï
                    roughness: 0.8,
                    metalness: 0.1,
                    transparent: true,
                    opacity: 0.7 // ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏∂‡∏ö‡∏•‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÄ‡∏î‡πà‡∏ô‡∏ä‡∏±‡∏î
                });
                buildingMesh = new THREE.Mesh(buildingGeometry, buildingMaterial);
                buildingMesh.position.set(config.x, totalHeight/2, config.z);
                buildingMesh.castShadow = true;
                buildingMesh.receiveShadow = true;
                group.add(buildingMesh);
            }

            let maxFloors = (buildingNumber === 7) ? 5 : 7;
            for (let floor = 1; floor < maxFloors; floor++) {
                let lineGeometry;
                if (buildingNumber === 7) {
                    const pentagonShape = new THREE.Shape();
                    const r = (config.width / 2);
                    for (let i = 0; i < 5; i++) {
                        const angle = (i / 5) * Math.PI * 2 - Math.PI / 2;
                        const x = Math.cos(angle) * r;
                        const y = Math.sin(angle) * r;
                        if (i === 0) pentagonShape.moveTo(x, y);
                        else pentagonShape.lineTo(x, y);
                    }
                    pentagonShape.closePath();
                    const extrudeSettings = {
                        steps: 1,
                        depth: 0.1 * BUILDING_SCALE,
                        bevelEnabled: false
                    };
                    lineGeometry = new THREE.ExtrudeGeometry(pentagonShape, extrudeSettings);
                    lineGeometry.rotateX(Math.PI / 2);
                } else {
                    lineGeometry = new THREE.PlaneGeometry(config.width, config.depth);
                }
                const lineMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0xFFFFFF,
                    side: THREE.DoubleSide,
                    transparent: true,
                    opacity: 0.18
                });
                const line = new THREE.Mesh(lineGeometry, lineMaterial);
                if (buildingNumber === 7) {
                    line.position.set(config.x, floor * floorHeight, config.z);
                } else {
                    line.position.set(config.x, floor * floorHeight, config.z);
                    line.rotation.x = Math.PI / 2;
                }
                group.add(line);
            }

            createWindowsAndFrames(group, config, totalHeight, buildingNumber, BUILDING_SCALE);
            createDoor(group, config, totalHeight, BUILDING_SCALE);
            createFlatRoof(group, config, totalHeight, buildingNumber, BUILDING_SCALE);

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏µ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏∂‡∏Å‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            if (buildingNumber !== 7) {
                createColoredRooms(group, config, totalHeight, buildingNumber, BUILDING_SCALE);
            }

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡πÉ‡∏ô‡∏ï‡∏∂‡∏Å‡∏´‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° (buildingNumber === 7)
            // (‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏≠‡∏≠‡∏Å ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á)
            // if (buildingNumber === 7) {
            //     ...
            // }

            return { group, config };
        }

        function getRoomType(floor, buildingNumber) {
            const roomTypes = [
                "‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
                "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£",
                "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°",
                "‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
                "‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î",
                "‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
                "‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô"
            ];
            
            if (buildingNumber >= 1 && buildingNumber <= 3) {
                return `‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${floor + 1}`;
            } else if (buildingNumber >= 4 && buildingNumber <= 6) {
                return `‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£ ${floor + 1}`;
            } else {
                return roomTypes[floor % roomTypes.length];
            }
        }

        function getCellValue(sheetData, row, col) {
          const colIndex = col.charCodeAt(0) - 'A'.charCodeAt(0);
          return (sheetData[row - 1] && sheetData[row - 1][colIndex]) || '';
        }

        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        async function fetchSheetData() {
          const apiKey = 'AIzaSyCcOGXLl1WhKknUNzuc16GeH75huYWovhc';
          const sheetId = '1bdPov0X_M_IRYxRN-V6XH_nQzfTNREO9XAbdOnd2u_g';
          const range = 'A1:Z100';
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
          const response = await fetch(url);
          const data = await response.json();
          sheetData = data.values;
        }
        fetchSheetData(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô

        function onRoomClick(room) {
            selectedRoom = room;
            const roomName = room.userData.roomType;
            lastSelectedRoomName = roomName;
            const mapping = roomDataMapping[roomName];
            if (!mapping) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö mapping ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ');
                return;
            }
            if (!sheetData) {
                alert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà');
                return;
            }
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ row ‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô sheetData ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            let row = null;
            for (let i = 1; i < sheetData.length; i++) {
              if ((sheetData[i][0] || '').replace(/\s+/g, '').toLowerCase() === roomName.replace(/\s+/g, '').toLowerCase()) {
                row = sheetData[i];
                break;
              }
            }
            const header = sheetData[0];
            if (!row) {
              alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Google Sheet');
              return;
            }
            const value = getCellValue(sheetData, mapping.row, mapping.col);
            document.getElementById('chartTitle').textContent =
                `‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£ ${room.userData.buildingNumber} - ${room.userData.roomType}`;
            let listHtml = '<div class="risk-detail-list">';
            for (let j = 2; j <= 12; j++) { // C ‡∏ñ‡∏∂‡∏á M
                if (header[j] && header[j] !== '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á') {
                    const val = (row && row[j] !== undefined) ? row[j] : '-';
                    // ‡πÄ‡∏û‡∏¥‡πà‡∏° class ‡πÅ‡∏•‡∏∞‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                    let statusClass = '';
                    let icon = '';
                    if (val === "‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå") {
                        statusClass = 'passed';
                        icon = '<span class="status-icon">‚úîÔ∏è</span>';
                    } else if (val === "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå") {
                        statusClass = 'failed';
                        icon = '<span class="status-icon">‚ùå</span>';
                    } else if (val === "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö" || (typeof val === 'string' && val.trim().toLowerCase() === 'optional')) {
                        statusClass = 'pending';
                        icon = '<span class="status-icon">‚è≥</span>';
                    }
                    listHtml += `<div class='risk-detail-row'><span class='risk-detail-label'>${header[j]}</span><span class='risk-detail-value ${statusClass}'>${icon}${val}</span></div>`;
                }
            }
            listHtml += '</div>';
            // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå C (index 2)
            const riskValue = row[1] || '-';
            const riskLevel = row[2] || '-';
            document.getElementById('chartDiv').innerHTML = `
                <div class='risk-summary'>
                  <div class='risk-title'>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
                  <div class='risk-value'>${riskValue}</div>
                </div>
                ${listHtml}
            `;
            document.getElementById('chartContainer').style.display = 'block';
            document.getElementById('pieChartContainer').style.display = 'none'; // ‡∏ã‡πà‡∏≠‡∏ô Pie Chart ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô (‡∏≠‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
            showPieChartForRoom(header, row); // ‡∏™‡πà‡∏á header, row ‡πÑ‡∏õ‡∏ß‡∏≤‡∏î Pie Chart ‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà
        }

        function closeChart() {
            document.getElementById('chartContainer').style.display = 'none';
            document.getElementById('pieChartContainer').style.display = 'none';
            selectedRoom = null;
        }

        function closePieChart() {
            document.getElementById('pieChartContainer').style.display = 'none';
        }

        function createChartsForRoom(data, roomData) {
            let header = data[0];
            let matchedRow = data[1];
            if (!matchedRow) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ (roomType: ' + roomData.roomType + ')');
                return;
            }
            const chartData = [['‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠', '‡∏Ñ‡πà‡∏≤']];
            for (let j = 1; j < matchedRow.length; j++) {
                if (header[j] && matchedRow[j]) {
                    let value = matchedRow[j];
                    if (!isNaN(parseFloat(value)) && isFinite(value)) {
                        value = parseFloat(value);
                    }
                    chartData.push([header[j], value]);
                }
            }
            console.log('DEBUG: chartData ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü:', chartData);
            drawColumnChart(chartData, roomData);
            drawPieChart(chartData, roomData);
        }

        function drawColumnChart(chartData, roomData) {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(() => {
                try {
                    const chart = new google.visualization.ColumnChart(document.getElementById('chartDiv'));
                    const options = {
                        title: `${roomData.roomType}`,
                        width: 350,
                        height: 250,
                        backgroundColor: 'transparent',
                        titleTextStyle: { color: '#333', fontSize: 14 },
                        legend: { textStyle: { color: '#333' } },
                        hAxis: { textStyle: { color: '#333' } },
                        vAxis: { textStyle: { color: '#333' } },
                        chartArea: { left: 40, top: 30, width: '80%', height: '70%' }
                    };
                    chart.draw(google.visualization.arrayToDataTable(chartData), options);
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Column Chart: ' + error.message);
                }
            });
        }

        function drawPieChart(chartData, roomData) {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(() => {
                try {
                    const chart = new google.visualization.PieChart(document.getElementById('pieChartDiv'));
                    const options = {
                        title: `${roomData.roomType}`,
                        width: 280,
                        height: 220,
                        backgroundColor: 'transparent',
                        titleTextStyle: { color: '#333', fontSize: 14 },
                        legend: { textStyle: { color: '#333' } },
                        pieSliceText: 'value',
                        chartArea: { left: 10, top: 30, width: '90%', height: '80%' }
                    };
                    chart.draw(google.visualization.arrayToDataTable(chartData), options);
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Pie Chart: ' + error.message);
                }
            });
        }

        // ‡∏õ‡∏£‡∏±‡∏ö loadRoomDataAndCreateChart ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å createChartsForRoom
        function loadRoomDataAndCreateChart(roomData) {
            const dataSource = document.getElementById('dataSource').value;
            switch(dataSource) {
                case 'sheets':
                    loadDataFromGoogleSheets(roomData)
                        .then(data => {
                            if (data && data.length > 0) {
                                createChartsForRoom(data, roomData);
                            } else {
                                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets');
                            }
                        })
                        .catch(error => {
                            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets: ' + error);
                        });
                    break;
                case 'excel':
                    if (uploadedExcelData) {
                        const excelData = processExcelData(uploadedExcelData, roomData);
                        if (excelData && excelData.length > 0) {
                            createChartsForRoom(excelData, roomData);
                        } else {
                            alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Excel');
                        }
                    } else {
                        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏Å‡πà‡∏≠‡∏ô');
                    }
                    break;
                default:
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    break;
            }
        }

        async function loadDataFromGoogleSheets(roomData) {
            try {
                console.log('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...');
                console.log('Room Data:', roomData);
                
                // ‡πÉ‡∏ä‡πâ Google Sheets API v4
                const apiKey = 'AIzaSyCcOGXLl1WhKknUNzuc16GeH75huYWovhc';
                const sheetId = '1bdPov0X_M_IRYxRN-V6XH_nQzfTNREO9XAbdOnd2u_g';
                const range = 'A1:Z100'; // ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
                console.log('URL:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Google Sheets Data:', data);
                
                if (data.values && data.values.length > 0) {
                    console.log('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheets:', data.values.length, '‡πÅ‡∏ñ‡∏ß');
                    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheets ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Å‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á
                    const processedData = processSheetData(data.values, roomData);
                    console.log('Processed Data:', processedData);
                    return processedData;
                } else {
                    console.log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheets');
                    return null;
                }
                
            } catch (error) {
                console.error('Error loading from Google Sheets:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets: ' + error.message);
                return null;
            }
        }

        function processSheetData(sheetData, roomData) {
            console.log('Processing sheet data for room:', roomData);
            console.log('Raw sheet data:', sheetData);
            
            // ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô lowercase ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
            const targetName = (roomData.roomType || '').replace(/\s+/g, '').toLowerCase();
            let matchedRow = null;
            let header = sheetData[0];
            
            // ‡∏´‡∏≤ header
            if (sheetData.length > 0) {
                // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                for (let i = 1; i < sheetData.length; i++) {
                    const row = sheetData[i];
                    const sheetName = (row[0] || '').replace(/\s+/g, '').toLowerCase();
                    console.log(`‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö: '${targetName}' <-> '${sheetName}'`);
                    if (sheetName === targetName) {
                        matchedRow = row;
                        break;
                    }
                }
            }
            if (!matchedRow) {
                console.log('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏£‡∏Å');
                return null;
            }
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≤‡∏Å header ‡πÅ‡∏•‡∏∞ matchedRow (‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 0)
            const chartData = [['‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠', '‡∏Ñ‡πà‡∏≤']];
            for (let j = 1; j < matchedRow.length; j++) {
                if (header[j] && matchedRow[j]) {
                    let value = matchedRow[j];
                    if (!isNaN(parseFloat(value)) && isFinite(value)) {
                        value = parseFloat(value);
                    }
                    chartData.push([header[j], value]);
                }
            }
            console.log('DEBUG: chartData ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü:', chartData);
            return [header, matchedRow]; // ‡∏™‡πà‡∏á header ‡∏Å‡∏±‡∏ö matchedRow ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ createChartsForRoom ‡πÉ‡∏ä‡πâ
        }

        function generateMockData(roomData) {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡πâ‡∏≠‡∏á
            const data = [];
            
            if (roomData.roomType.includes('‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô')) {
                data.push(['‡∏ß‡∏¥‡∏ä‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']);
                data.push(['‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', Math.floor(Math.random() * 30) + 20]);
                data.push(['‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', Math.floor(Math.random() * 30) + 20]);
                data.push(['‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢', Math.floor(Math.random() * 30) + 20]);
                data.push(['‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', Math.floor(Math.random() * 30) + 20]);
            } else if (roomData.roomType.includes('‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£')) {
                data.push(['‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']);
                data.push(['‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', Math.floor(Math.random() * 20) + 10]);
                data.push(['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠', Math.floor(Math.random() * 15) + 5]);
                data.push(['‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô', Math.floor(Math.random() * 10) + 5]);
            } else {
                data.push(['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']);
                data.push(['‡πÇ‡∏ï‡πä‡∏∞', Math.floor(Math.random() * 20) + 10]);
                data.push(['‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ', Math.floor(Math.random() * 30) + 20]);
                data.push(['‡∏ï‡∏π‡πâ', Math.floor(Math.random() * 5) + 2]);
            }
            
            return data;
        }

        function createWindowsAndFrames(group, config, totalHeight, buildingNumber, scale) {
            const windowSize = 0.9 * scale;
            const frameSize = windowSize + 0.12 * scale;
            const windowInset = 0.05 * scale;
            const frameInset = 0.045 * scale;
            const margin = windowSize / 2 + 0.15 * scale;
            const windowMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x3a5a7a,
                roughness: 0.15,
                metalness: 0.7,
                transparent: true,
                opacity: 0.45,
                emissive: 0x0a1a2a,
                emissiveIntensity: 0.12
            });
            const frameMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x222222,
                metalness: 0.5,
                roughness: 0.3
            });
            let maxFloors = (buildingNumber === 7) ? 5 : 7;
            if (buildingNumber === 7) {
                return;
            }
            // ‡∏ï‡∏∂‡∏Å‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° (‡πÉ‡∏ä‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏°)
            const numFrontBack = Math.max(1, Math.floor((config.width - 2 * margin) / 2));
            for (let floor = 0; floor < maxFloors; floor++) {
                for (let i = 0; i < numFrontBack; i++) {
                    const x = config.x - config.width/2 + margin + (i + 0.5) * ((config.width - 2 * margin) / numFrontBack);
                    // ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    const windowFront = new THREE.Mesh(
                        new THREE.PlaneGeometry(windowSize, windowSize),
                        windowMaterial
                    );
                    windowFront.position.set(
                        x,
                        3.2/2 + floor * 3.2 * scale,
                        config.z + config.depth/2 - windowInset * scale
                    );
                    windowFront.rotation.y = 0;
                    group.add(windowFront);
                    // ‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤
                    const frameFront = new THREE.Mesh(
                        new THREE.PlaneGeometry(frameSize, frameSize),
                        frameMaterial
                    );
                    frameFront.position.set(
                        x,
                        windowFront.position.y,
                        config.z + config.depth/2 - frameInset * scale
                    );
                    frameFront.rotation.y = 0;
                    group.add(frameFront);
                    // ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏á
                    const windowBack = new THREE.Mesh(
                        new THREE.PlaneGeometry(windowSize, windowSize),
                        windowMaterial
                    );
                    windowBack.position.set(
                        x,
                        3.2/2 + floor * 3.2 * scale,
                        config.z - config.depth/2 + windowInset * scale
                    );
                    windowBack.rotation.y = Math.PI;
                    group.add(windowBack);
                    // ‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á
                    const frameBack = new THREE.Mesh(
                        new THREE.PlaneGeometry(frameSize, frameSize),
                        frameMaterial
                    );
                    frameBack.position.set(
                        x,
                        windowBack.position.y,
                        config.z - config.depth/2 + frameInset * scale
                    );
                    frameBack.rotation.y = Math.PI;
                    group.add(frameBack);
                }
            }
            const numSide = Math.max(1, Math.floor((config.depth - 2 * margin) / 2));
            for (let floor = 0; floor < maxFloors; floor++) {
                for (let i = 0; i < numSide; i++) {
                    const z = config.z - config.depth/2 + margin + (i + 0.5) * ((config.depth - 2 * margin) / numSide);
                    // ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
                    const windowLeft = new THREE.Mesh(
                        new THREE.PlaneGeometry(windowSize, windowSize),
                        windowMaterial
                    );
                    windowLeft.position.set(
                        config.x - config.width/2 + windowInset * scale,
                        3.2/2 + floor * 3.2 * scale,
                        z
                    );
                    windowLeft.rotation.y = -Math.PI / 2;
                    group.add(windowLeft);
                    // ‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
                    const frameLeft = new THREE.Mesh(
                        new THREE.PlaneGeometry(frameSize, frameSize),
                        frameMaterial
                    );
                    frameLeft.position.set(
                        config.x - config.width/2 + frameInset * scale,
                        windowLeft.position.y,
                        z
                    );
                    frameLeft.rotation.y = -Math.PI / 2;
                    group.add(frameLeft);
                    // ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
                    const windowRight = new THREE.Mesh(
                        new THREE.PlaneGeometry(windowSize, windowSize),
                        windowMaterial
                    );
                    windowRight.position.set(
                        config.x + config.width/2 - windowInset * scale,
                        3.2/2 + floor * 3.2 * scale,
                        z
                    );
                    windowRight.rotation.y = Math.PI / 2;
                    group.add(windowRight);
                    // ‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤
                    const frameRight = new THREE.Mesh(
                        new THREE.PlaneGeometry(frameSize, frameSize),
                        frameMaterial
                    );
                    frameRight.position.set(
                        config.x + config.width/2 - frameInset * scale,
                        windowRight.position.y,
                        z
                    );
                    frameRight.rotation.y = Math.PI / 2;
                    group.add(frameRight);
                }
            }
        }

        function createPentagonWindows(group, config, totalHeight, scale) {
            const windowSize = 0.8 * scale;
            const frameSize = windowSize + 0.1 * scale;
            const windowInset = 0.05 * scale;
            const frameInset = 0.04 * scale;
            
            const windowMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x3a5a7a,
                roughness: 0.15,
                metalness: 0.7,
                transparent: true,
                opacity: 0.6,
                emissive: 0x0a1a2a,
                emissiveIntensity: 0.15
            });
            const frameMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x222222,
                metalness: 0.5,
                roughness: 0.3
            });
            
            const floorHeight = 3.2 * scale;
            const r = config.width / 2;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏ï‡∏∂‡∏Å‡∏´‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°
            for (let floor = 0; floor < 5; floor++) {
                for (let side = 0; side < 5; side++) {
                    const angle = (side / 5) * Math.PI * 2 - Math.PI / 2;
                    const x = config.x + Math.cos(angle) * (r - windowInset * scale);
                    const z = config.z + Math.sin(angle) * (r - windowInset * scale);
                    
                    // ‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                    const window = new THREE.Mesh(
                        new THREE.PlaneGeometry(windowSize, windowSize),
                        windowMaterial
                    );
                    window.position.set(
                        x,
                        floorHeight/2 + floor * floorHeight,
                        z
                    );
                    window.rotation.y = angle + Math.PI / 2;
                    group.add(window);
                    
                    // ‡∏Å‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                    const frame = new THREE.Mesh(
                        new THREE.PlaneGeometry(frameSize, frameSize),
                        frameMaterial
                    );
                    frame.position.set(
                        config.x + Math.cos(angle) * (r - frameInset * scale),
                        floorHeight/2 + floor * floorHeight,
                        config.z + Math.sin(angle) * (r - frameInset * scale)
                    );
                    frame.rotation.y = angle + Math.PI / 2;
                    group.add(frame);
                }
            }
        }

        function createDoor(group, config, totalHeight, scale) {
            const doorWidth = 1.2 * scale;
            const doorHeight = 2.2 * scale;
            const doorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x444444,
                roughness: 0.4,
                metalness: 0.2
            });
            const door = new THREE.Mesh(
                new THREE.PlaneGeometry(doorWidth, doorHeight),
                doorMaterial
            );
            door.position.set(config.x, doorHeight/2, config.z + config.depth/2 + 0.03 * scale);
            group.add(door);
        }

        function createFlatRoof(group, config, totalHeight, buildingNumber, scale = 1) {
            if (buildingNumber === 7) {
                // ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤‡∏´‡πâ‡∏≤‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏Ç‡∏ô‡∏≤‡∏ô‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏ï‡∏∂‡∏Å (shape centered at 0,0)
                const r = config.width / 2 + 0.1 * scale; // ‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏∏‡∏°‡∏Ç‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏Å‡∏±‡∏ö scale
                const pentagonShape = new THREE.Shape();
                for (let i = 0; i < 5; i++) {
                    const angle = (i / 5) * Math.PI * 2 - Math.PI / 2;
                    const x = Math.cos(angle) * r;
                    const z = Math.sin(angle) * r;
                    if (i === 0) pentagonShape.moveTo(x, z);
                    else pentagonShape.lineTo(x, z);
                }
                pentagonShape.closePath();
                const geometry = new THREE.ShapeGeometry(pentagonShape);
                geometry.rotateX(Math.PI / 2);
                const material = new THREE.MeshStandardMaterial({ 
                    color: 0xcccccc,
                    roughness: 0.3,
                    metalness: 0.1
                });
                const roof = new THREE.Mesh(geometry, material);
                roof.position.set(config.x, totalHeight + 0.09 * scale, config.z);
                roof.castShadow = true;
                group.add(roof);
            } else {
                // ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡∏≤‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°
                const roofGeometry = new THREE.BoxGeometry(
                    config.width + 0.2 * scale,
                    0.18 * scale,
                    config.depth + 0.2 * scale
                );
                const roofMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xcccccc,
                    roughness: 0.3,
                    metalness: 0.1
                });
                const roof = new THREE.Mesh(roofGeometry, roofMaterial);
                roof.position.set(config.x, totalHeight + 0.09 * scale, config.z);
                roof.castShadow = true;
                group.add(roof);
            }
        }

        function createEnvironment() {
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡∏£‡∏≠‡∏ö‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
            for (let i = 0; i < 15; i++) {
                const tree = createTree();
                tree.position.set(
                    (Math.random() - 0.5) * 100,
                    0,
                    (Math.random() - 0.5) * 100
                );
                // ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ‡πÉ‡∏Å‡∏•‡πâ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                if (Math.abs(tree.position.x) > 30 || Math.abs(tree.position.z) > 25) {
                    scene.add(tree);
                }
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏Ü
            return createClouds();
        }

        function createTree() {
            const group = new THREE.Group();
            
            // ‡∏•‡∏≥‡∏ï‡πâ‡∏ô
            const trunkGeometry = new THREE.CylinderGeometry(0.3, 0.5, 4);
            const trunkMaterial = new THREE.MeshPhongMaterial({ color: 0x8B4513});
            const trunk = new THREE.Mesh(trunkGeometry, trunkMaterial);
            trunk.position.y = 2;
            trunk.castShadow = true;
            group.add(trunk);
            
            // ‡πÉ‡∏ö‡πÑ‡∏°‡πâ
            const leavesGeometry = new THREE.SphereGeometry(2.5);
            const leavesMaterial = new THREE.MeshPhongMaterial({ color: 0x228B22 });
            const leaves = new THREE.Mesh(leavesGeometry, leavesMaterial);
            leaves.position.y = 6;
            leaves.castShadow = true;
            group.add(leaves);
            
            return group;
        }

        function createClouds() {
            const clouds = []; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏°‡∏Ü‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå
            for (let i = 0; i < 8; i++) {
                const cloud = new THREE.Group();
                cloud.userData = { isCloud: true }; // ‡πÄ‡∏û‡∏¥‡πà‡∏° flag ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏Ü
                
                for (let j = 0; j < 5; j++) {
                    const cloudPart = new THREE.Mesh(
                        new THREE.SphereGeometry(3 + Math.random() * 2),
                        new THREE.MeshPhongMaterial({ 
                            color: 0xffffff,
                            transparent: true,
                            opacity: 0.8
                        })
                    );
                    cloudPart.position.set(
                        (Math.random() - 0.5) * 10,
                        0,
                        (Math.random() - 0.5) * 10
                    );
                    cloud.add(cloudPart);
                }
                
                cloud.position.set(
                    (Math.random() - 0.5) * 200,
                    60 + Math.random() * 20,
                    (Math.random() - 0.5) * 200
                );
                clouds.push(cloud); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏Ü‡∏•‡∏á‡πÉ‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå
                scene.add(cloud);
            }
            return clouds; // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡πÄ‡∏°‡∏Ü
        }

        function setupControls() {
            // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á
            document.getElementById('viewSelect').addEventListener('change', (e) => {
                switch(e.target.value) {
                    case 'perspective':
                        camera.position.set(50, 40, 50);
                        camera.lookAt(0, 0, 0);
                        break;
                    case 'top':
                        camera.position.set(0, 80, 0);
                        camera.lookAt(0, 0, 0);
                        break;
                    case 'front':
                        camera.position.set(0, 20, 60);
                        camera.lookAt(0, 10, 0);
                        break;
                    case 'side':
                        camera.position.set(60, 20, 0);
                        camera.lookAt(0, 10, 0);
                        break;
                }
            });

            // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏™‡∏á
            document.getElementById('lightIntensity').addEventListener('input', (e) => {
                scene.children.forEach(child => {
                    if (child instanceof THREE.DirectionalLight) {
                        child.intensity = parseFloat(e.target.value);
                    }
                });
            });

            // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            document.getElementById('dataSource').addEventListener('change', (e) => {
                const fileUploadGroup = document.getElementById('fileUploadGroup');
                if (e.target.value === 'excel') {
                    fileUploadGroup.style.display = 'block';
                } else {
                    fileUploadGroup.style.display = 'none';
                }
            });

            // ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel
            document.getElementById('excelFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            
                            // ‡πÉ‡∏ä‡πâ sheet ‡πÅ‡∏£‡∏Å
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            
                            // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                            uploadedExcelData = jsonData;
                            
                            alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                        } catch (error) {
                            console.error('Error reading Excel file:', error);
                            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            });

            // ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏°‡∏≤‡∏™‡πå
            let mouseDown = false;
            let mouseX = 0;
            let mouseY = 0;

            renderer.domElement.addEventListener('mousedown', (e) => {
                mouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
                autoRotate = false;
            });

            renderer.domElement.addEventListener('mouseup', () => {
                mouseDown = false;
                setTimeout(() => { autoRotate = true; }, 2000);
            });

            renderer.domElement.addEventListener('mousemove', (e) => {
                if (!mouseDown) return;
                
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;
                
                // ‡∏´‡∏°‡∏∏‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á
                const spherical = new THREE.Spherical();
                spherical.setFromVector3(camera.position);
                spherical.theta -= deltaX * 0.01;
                spherical.phi += deltaY * 0.01;
                spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
                
                camera.position.setFromSpherical(spherical);
                camera.lookAt(0, 0, 0);
                
                mouseX = e.clientX;
                mouseY = e.clientY;
            });

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡πâ‡∏≠‡∏á
            renderer.domElement.addEventListener('click', (e) => {
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÉ‡∏ô normalized device coordinates
                mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                
                // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï raycaster
                raycaster.setFromCamera(mouse, camera);
                
                // ‡∏´‡∏≤‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å
                const intersects = raycaster.intersectObjects(scene.children, true);
                
                if (intersects.length > 0) {
                    const clickedObject = intersects[0].object;
                    
                    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                    if (clickedObject.userData && clickedObject.userData.isRoom) {
                        onRoomClick(clickedObject);
                    }
                }
            });

            // ‡∏Å‡∏≤‡∏£ Zoom ‡∏î‡πâ‡∏ß‡∏¢‡∏•‡πâ‡∏≠‡πÄ‡∏°‡∏≤‡∏™‡πå
            renderer.domElement.addEventListener('wheel', (e) => {
                const zoomSpeed = 1;
                const direction = new THREE.Vector3();
                camera.getWorldDirection(direction);
                
                if (e.deltaY > 0) {
                    camera.position.add(direction.multiplyScalar(-zoomSpeed * 5));
                } else {
                    camera.position.add(direction.multiplyScalar(zoomSpeed * 5));
                }
            });

            // ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function animate(clouds) {
            requestAnimationFrame(() => animate(clouds));
            
            // ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏Ü
            if (clouds && clouds.length > 0) {
                clouds.forEach(cloud => {
                    if (cloud.userData && cloud.userData.isCloud) {
                        cloud.position.x += 0.1;
                        if (cloud.position.x > 100) {
                            cloud.position.x = -100;
                        }
                    }
                });
            }
            
            renderer.render(scene, camera);
        }

        function createColoredRooms(group, config, totalHeight, buildingNumber, scale) {
            // ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® customRoomNames ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏ï‡πâ‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô)
            const customRoomNames = {
                '1-0': '‡∏Å‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£',
                '1-2': '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏ï‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï',
                '1-4': '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏™‡∏≤‡∏£‡∏ô‡∏¥‡πÄ‡∏ó‡∏®',
                '1-6': '‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏ô‡∏±‡∏Å‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç',
                '2-0': '‡∏™‡πç‡∏≤‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏≤‡∏ô‡∏∏‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡πç‡∏≤‡∏ö‡∏±‡∏î‡∏£‡∏±‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏¢‡∏≤‡πÄ‡∏™‡∏û‡∏ï‡∏¥‡∏î',
                '2-2': '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç',
                '2-4': '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏û‡∏ó‡∏¢‡πå‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå',
                '2-6': '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•',
                '3-0': '‡∏Å‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•',
                '3-2': '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°',
                '3-4': '‡∏Å‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á',
                '3-6': '‡∏Å‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á',
                '4-0': '‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢',
                '4-2': '‡∏Å‡∏≠‡∏á‡∏¢‡∏∏‡∏ó‡∏ò‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏á‡∏≤‡∏ô',
                '4-4': '‡∏Å‡∏≠‡∏á‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',
                '4-6': '‡∏Å‡∏≠‡∏á‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏õ‡∏ê‡∏°‡∏†‡∏π‡∏°‡∏¥',
                '5-0': '‡∏Å‡∏≠‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',
                '5-2': '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô',
                '5-4': '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£',
                '5-6': '‡∏Å‡∏≠‡∏á‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢',
                '6-0': '‡∏Å‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®',
                '6-2': '‡∏Å‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•',
                '6-4': '‡∏Å‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç',
                '6-6': '‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£',
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° mapping ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            };
            const roomColors = [
                0xFF0000, // ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏î
                0x00FF00, // ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏î
                0x0000FF, // ‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
                0xFFFF00, // ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏™‡∏î
                0xFF00FF, // ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏™‡∏î
                0x00FFFF, // ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏î
                0xFF8000  // ‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏™‡∏î
            ];
            
            const floorHeight = 3.2 * scale;
            const roomWidth = config.width * 0.4; // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏•‡∏á‡∏≠‡∏µ‡∏Å
            const roomDepth = config.depth * 0.4; // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏•‡∏á‡∏≠‡∏µ‡∏Å
            const roomHeight = floorHeight * 0.6; // ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏•‡∏á‡∏≠‡∏µ‡∏Å
            
            for (let floor = 0; floor < 7; floor++) {
                // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2, 4, ‡πÅ‡∏•‡∏∞ 6 (index 1, 3, 5)
                if (floor === 1 || floor === 3 || floor === 5) {
                    continue;
                }
                
                const roomColor = roomColors[floor % roomColors.length];
                const roomGeometry = new THREE.BoxGeometry(roomWidth, roomHeight, roomDepth);
                const roomMaterial = new THREE.MeshBasicMaterial({ 
                    color: roomColor,
                    transparent: true,
                    opacity: 0.9
                });
                const room = new THREE.Mesh(roomGeometry, roomMaterial);
                
                // ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£
                let roomX, roomZ;
                
                if (buildingNumber >= 1 && buildingNumber <= 3) {
                    // ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ - ‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏¥‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢
                    roomX = config.x - (config.width * 0.4);
                    roomZ = config.z;
                } else if (buildingNumber >= 4 && buildingNumber <= 6) {
                    // ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤ - ‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ä‡∏¥‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏Ç‡∏ß‡∏≤
                    roomX = config.x + (config.width * 0.4);
                    roomZ = config.z;
                } else {
                    // ‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÜ - ‡∏´‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á
                    roomX = config.x;
                    roomZ = config.z;
                }
                
                room.position.set(
                    roomX,
                    floorHeight/2 + floor * floorHeight,
                    roomZ
                );
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å
                let key;
                if (buildingNumber === 7) {
                    key = `${buildingNumber}-${1}`;
                } else {
                    key = `${buildingNumber}-${floor}`;
                }
                const roomName = customRoomNames[key] || `‡∏Å‡∏≠‡∏á ${key}`;
                room.userData = {
                    isRoom: true,
                    buildingNumber: buildingNumber,
                    floor: floor,
                    roomType: roomName,
                    color: roomColor
                };
                
                group.add(room);
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Excel (‡∏ú‡πà‡∏≤‡∏ô Google Sheets)
        async function loadDataFromExcel(roomData) {
            try {
                // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏µ‡πà 1: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Excel ‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheets ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ä‡πâ API
                const apiKey = 'AIzaSyCcOGXLl1WhKknUNzuc16GeH75huYWovhc';
                const sheetId = '1bdPov0X_M_IRYxRN-V6XH_nQzfTNREO9XAbdOnd2u_g';
                const range = 'A1:Z100';
                
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.values && data.values.length > 0) {
                    return processExcelData(data.values, roomData);
                }
                
                return null;
            } catch (error) {
                console.error('Error loading from Excel via Sheets:', error);
                return null;
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Excel
        function processExcelData(excelData, roomData) {
            // ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ö processSheetData ‡πÅ‡∏ï‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö excelData
            const targetName = (roomData.roomType || '').replace(/\s+/g, '').toLowerCase();
            let matchedRow = null;
            let header = excelData[0];
            if (excelData.length > 0) {
                for (let i = 1; i < excelData.length; i++) {
                    const row = excelData[i];
                    const sheetName = (row[0] || '').replace(/\s+/g, '').toLowerCase();
                    if (sheetName === targetName) {
                        matchedRow = row;
                        break;
                    }
                }
            }
            if (!matchedRow) {
                return null;
            }
            return [header, matchedRow];
        }

        function testGoogleSheets() {
            console.log('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets...');
            
            // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Sheets
            const apiKey = 'AIzaSyCcOGXLl1WhKknUNzuc16GeH75huYWovhc';
            const sheetId = '1bdPov0X_M_IRYxRN-V6XH_nQzfTNREO9XAbdOnd2u_g';
            const range = 'A1:Z100';
            
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
            
            fetch(url)
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å Google Sheets:', data);
                    
                    if (data.values && data.values.length > 0) {
                        console.log('üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏û‡∏ö:', data.values.length);
                        
                        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß
                        data.values.forEach((row, index) => {
                            console.log(`üìã ‡πÅ‡∏ñ‡∏ß ${index + 1}:`, row);
                        });
                        
                        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        let dataText = '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets:\n\n';
                        data.values.forEach((row, index) => {
                            dataText += `‡πÅ‡∏ñ‡∏ß ${index + 1}: ${row.join(' | ')}\n`;
                        });
                        
                        alert('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!\n\n' + dataText);
                    } else {
                        console.log('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheets');
                        alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Google Sheets\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:\n1. ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Sheet\n2. Sheet ‡πÄ‡∏õ‡πá‡∏ô Public');
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error:', error);
                    alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:\n\n' + error.message);
                });
        }

        function showPieChartFromColumnB() {
            if (!sheetData) {
                alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet');
                return;
            }
            console.log('sheetData:', sheetData);
            const header = sheetData[0];
            const dataRows = sheetData.slice(1);

            if (!header || header.length < 2) {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet');
                return;
            }

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á object ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
            const valueCount = {};

            dataRows.forEach((row, idx) => {
                if (!row || row.length < 2) {
                    console.log('‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B:', row);
                    return;
                }
                const value = row[1]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B (index 1)
                if (value) {
                    if (!isNaN(parseFloat(value)) && isFinite(value)) {
                        valueCount[header[1]] = (valueCount[header[1]] || 0) + parseFloat(value);
                    } else {
                        valueCount[value] = (valueCount[value] || 0) + 1;
                    }
                }
            });

            // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Pie Chart
            const chartData = [['‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']];
            for (const key in valueCount) {
                chartData.push([key, valueCount[key]]);
            }
            console.log('chartData for Pie Chart:', chartData);

            if (chartData.length <= 1) {
                alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå B ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Pie Chart');
                document.getElementById('pieChartContainer').style.display = 'none';
                return;
            }

            document.getElementById('pieChartContainer').style.display = 'block';
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(() => {
                try {
                    const chart = new google.visualization.PieChart(document.getElementById('pieChartDiv'));
                    const options = {
                        title: 'Pie Chart ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô',
                        width: 280,
                        height: 220,
                        backgroundColor: 'transparent',
                        titleTextStyle: { color: '#333', fontSize: 14 },
                        legend: { textStyle: { color: '#333' } },
                        pieSliceText: 'value',
                        chartArea: { left: 10, top: 30, width: '90%', height: '80%' }
                    };
                    chart.draw(google.visualization.arrayToDataTable(chartData), options);
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Pie Chart: ' + error.message);
                    document.getElementById('pieChartContainer').style.display = 'none';
                }
            });
        }

        // ‡∏õ‡∏£‡∏±‡∏ö showPieChartForRoom ‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö header, row ‡πÅ‡∏•‡∏∞‡∏ß‡∏≤‡∏î Pie Chart ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠-‡∏Ñ‡πà‡∏≤ (C ‡∏ñ‡∏∂‡∏á M)
        function showPieChartForRoom(header, row) {
            if (!header || !row) {
                document.getElementById('pieChartContainer2').style.display = 'none';
                return;
            }
            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÉ‡∏ô column C ‡∏ñ‡∏∂‡∏á M (‡∏£‡∏ß‡∏° '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö' ‡πÅ‡∏ó‡∏ô 'Optional' ‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö)
            const valueCount = {};
            for (let j = 2; j <= 12; j++) { // C ‡∏ñ‡∏∂‡∏á M
                let value = row[j];
                if (typeof value === 'string' && value.trim().toLowerCase() === 'optional') {
                    value = '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                }
                if (value === "‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå" || value === "‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå" || value === "‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö") {
                    valueCount[value] = (valueCount[value] || 0) + 1;
                }
            }
            const chartData = [['‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô']];
            for (const key in valueCount) {
                chartData.push([key, valueCount[key]]);
            }
            if (chartData.length <= 1) {
                document.getElementById('pieChartContainer2').style.display = 'none';
                return;
            }
            document.getElementById('pieChartContainer2').style.display = 'block';
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(() => {
                try {
                    const chart = new google.visualization.PieChart(document.getElementById('pieChartDiv2'));
                    const options = {
                        title: '‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á',
                        width: 280,
                        height: 220,
                        backgroundColor: 'transparent',
                        titleTextStyle: { color: '#333', fontSize: 14 },
                        legend: { textStyle: { color: '#333' } },
                        pieSliceText: 'value',
                        chartArea: { left: 10, top: 30, width: '90%', height: '80%' }
                    };
                    chart.draw(google.visualization.arrayToDataTable(chartData), options);
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Pie Chart: ' + error.message);
                    document.getElementById('pieChartContainer2').style.display = 'none';
                }
            });
        }

        function closePieChart2() {
            document.getElementById('pieChartContainer2').style.display = 'none';
        }

        let lastSelectedRoomName = null;

        async function refreshGoogleSheets() {
          await fetchSheetData();
          alert('‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
          // Refresh Pie Chart ‡∏£‡∏ß‡∏°
          showPieChartFromColumnB();
          // Refresh panel ‡∏Ç‡∏ß‡∏≤ (chartContainer) ‡∏î‡πâ‡∏ß‡∏¢ object ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏ô scene
          if (selectedRoom && selectedRoom.userData && selectedRoom.userData.roomType) {
            console.log('selectedRoom:', selectedRoom.userData.roomType);
            let foundRoom = null;
            scene.traverse(function(obj) {
              if (obj.userData && obj.userData.isRoom && obj.userData.roomType === selectedRoom.userData.roomType) {
                foundRoom = obj;
              }
            });
            console.log('foundRoom:', foundRoom ? foundRoom.userData.roomType : null);
            if (foundRoom) {
              onRoomClick(foundRoom);
            } else {
              document.getElementById('chartContainer').style.display = 'none';
              document.getElementById('pieChartContainer2').style.display = 'none';
              selectedRoom = null;
            }
          }
        }
    </script>
    <script>
      init();
    </script>
</body>
</html>
